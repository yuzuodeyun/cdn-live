# 直播录制需求

## 概述

### 需求背景

**直播产品原有录制接口，但无法适应客户CB需求，产品部门重新梳理直播录制需求，分析国内主流云及CDN供应商类似功能，整合编制此文档，提交研发人员调整重构以便产品更为通用。**

### 名词解释

|缩写、术语|解释|
|---|---|
|回调地址|客户系统接收通知的一个url地址|

## 需求描述

直播管理系统能够根据客户的指定流及时段，将正在直播的流录制下来，并在录制完成后通知给客户下载。

一般常见于主播推流的情况，拉流模式录制需求比较少见；客户具体使用的协议与格式对需求影响不大，CDN录制将源流按原始码率，以客户方便处理的格式存储，如最常见的rtmp推流录制为flv文件。


主要有以下两种使用场景：

### 自动录制场景

这个是CB的需求，针对所有该客户所有直播域名下的流生效，开播自动录制，关播自动停止。

主要流程分成两个阶段：

#### 配置阶段

售前了解到客户的回调地址，以及客户**需要开播通知**的需求后，进行————

自助配置：打开portal在客户的**直播域名特性页**上进行配置，然后就配置完了。

虽然梦想很丰满，但是现实很骨感，实际情况是————

手工配置：售前填写B类报告并通知客服，客服派工单给运维按需求配置。好吧，这种配置方法目前是完全可以接受的。
 

#### 直播阶段

1. 主播推某路流X到我司CDN源站；
2. CDN源站上流X的publish钩子调用**创建录制任务API**, 然后**post 回调地址**通知开始录制, 注意默认配置下不做开始录制通知。
3. 主播结束直播，断流unpublish的钩子被激活，调用**终止录制任务API**，在API处理程序内调用**post 回调地址**通知录制文件的地址。


### 录制特定时间段场景

1. 无需CDN端进行配置。
2. 客户直播管理系统控制调用**创建录制任务API**与**终止录制任务API**的时机，指定流与时间范围。
3. 在**终止录制任务API**处理程序内调用**post 回调地址**通知录制文件的地址。
4. 通过**查看已录制任务**，查看指定流已经录制的文件。

### 关键点

1. 录制的时长过长，生成文件太大————考虑每30分钟生成一个文件
2. 存储保存时间————考虑按客户分级保存，金牌客户24小时，VIP客户7天，SVIP客户30天。过期自动清理。
2. 存储节点的带宽————双线1G够不够？
2. 存储的性能————上万路流同时写入，IO够不够？
3. 录制流名通用匹配规则，录制时间范围规则的通用定义————目前可暂不考虑
4. 意外断流的处理————断流总调用**终止录制任务API**，对于**录制特定时间段场景**不予以自动恢复。

## API

### 创建录制任务

	PUT /stream/{id}/record

参数

|字段|必填|描述|
|---|---|---|
|startime|否|录制开始时间，精确到分钟201605300900，不填代表当前时间2分钟后|
|endtime|否|录制结束时间，精确到分钟201605300900，不填代表直播结束|
|callbackurl|否|回调地址，录制完成后将生成文件的地址以**查看已录制任务**的格式，POST到这个url上通知客户获取，不填不通知，|

返回值

	{
		status:"ok"
	}

### 终止录制任务

	DELETE /stream/{id}/record

返回值

	{
		status:"ok"
	}

### 查看已录制任务

	GET /stream/{id}/records

参数

|字段|必填|描述|
|---|---|---|
|startime|否|查询开始时间，精确到分钟201605300900，不填代表197001010000|
|endtime|否|录制结束时间，精确到分钟201605300900，不填代表系统当前时间|

返回值

	{
		records:[
			{
				strar:"20160527204055",
				end:"20160527204500",
				url:"http://whereisdisk.com/v0/22343242/3412341234214.flv"
			}
		]
	}	
